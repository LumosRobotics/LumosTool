# STM32H7 UART Example

This example project demonstrates UART communication on the STM32H723 microcontroller using the Lumos build tool.

## Overview

This project initializes USART3 to send messages over UART at 115200 baud. It demonstrates:

- **System clock configuration** - Configures the H7 to run at 550 MHz
- **UART initialization** - Sets up USART3 with GPIO pins
- **HAL usage** - Uses the STM32H7 HAL library
- **Periodic output** - Sends a counter message every second

## Hardware Requirements

### STM32H7 Board
- **MCU**: STM32H723VG (or compatible H7 variant)
- **Clock**: 25 MHz external crystal (HSE)
- **UART Pins**:
  - PD8 - USART3_TX (transmit)
  - PD9 - USART3_RX (receive)

### USB-to-Serial Adapter
You'll need a USB-to-Serial adapter (e.g., FTDI, CP2102) to connect to your PC.

### Connections

```
STM32H7          USB-Serial Adapter
-------          ------------------
PD8 (TX)    -->  RX
PD9 (RX)    <--  TX
GND         -->  GND
```

**Important**: Connect TX to RX and RX to TX (crossover).

## Project Configuration

The `project.yaml` file defines your project:

```yaml
sources:
  - src/main.c
  - src/uart_config.c

hal_modules:
  - uart

board: LumosBrain
```

**Fields:**
- `sources`: List of your application source files (.c, .cpp, .s)
- `hal_modules`: Optional list of HAL peripheral modules to include
- `board`: Board name (determines platform, MCU, CPU, etc.)

## Building

From the `example_uart` directory, run:

```bash
lumos build
```

Or using the full path:

```bash
/path/to/LumosTool/build/src/applications/lumos_simple/lumos_simple build
```

### Build Output

The build will create:
- `build/firmware.elf` - ELF file with debug symbols
- `build/firmware.bin` - Raw binary for flashing
- `build/firmware.map` - Memory map file

Expected binary size: ~12-13 KB

## Flashing

Flash the firmware to your STM32H7 board using ST-Link or another programmer:

### Using ST-Link

```bash
st-flash write build/firmware.bin 0x8000000
```

### Using OpenOCD

```bash
openocd -f interface/stlink.cfg -f target/stm32h7x.cfg \
  -c "program build/firmware.elf verify reset exit"
```

### Using STM32CubeProgrammer

1. Open STM32CubeProgrammer
2. Connect to your board
3. Load `build/firmware.bin`
4. Set address to `0x08000000`
5. Click "Start Programming"

## Serial Monitor

After flashing, open a serial monitor to view the output.

### Serial Settings

- **Baud rate**: 115200
- **Data bits**: 8
- **Parity**: None
- **Stop bits**: 1
- **Flow control**: None

### Using screen (Linux/macOS)

```bash
screen /dev/ttyUSB0 115200
```

To exit: Press `Ctrl-A` then `K`, then `Y` to confirm.

### Using minicom (Linux)

```bash
minicom -D /dev/ttyUSB0 -b 115200
```

### Using PuTTY (Windows)

1. Open PuTTY
2. Select "Serial"
3. Set Serial line to `COM3` (or your port)
4. Set Speed to `115200`
5. Click "Open"

## Expected Output

When you connect to the serial port, you should see:

```
========================================
  STM32H7 UART Example
  Lumos Build Tool Demo
========================================

System Clock: 550 MHz
HCLK: 275 MHz
UART Baudrate: 115200 bps

Starting counter...

[     0] Hello from STM32H7! System running at 550 MHz
[     1] Hello from STM32H7! System running at 550 MHz
[     2] Hello from STM32H7! System running at 550 MHz
[     3] Hello from STM32H7! System running at 550 MHz
...
```

The counter increments every second.

## Code Structure

### Files

```
example_uart/
├── README.md                    # This file
├── project.yaml                 # Build configuration
├── include/
│   └── uart_config.h           # UART configuration defines
├── src/
│   ├── main.c                  # Main application
│   └── uart_config.c           # UART and clock init
└── build/                      # Generated by build (output)
```

**Note**: You only need to provide your application code. The Lumos build tool automatically compiles the necessary HAL drivers from the platform directory.

### Key Functions

**main.c:main()**
- Initializes HAL library
- Configures system clock to 550 MHz
- Initializes UART
- Sends startup banner and system info
- Runs infinite loop sending counter messages

**uart_config.c:SystemClock_Config()**
- Configures PLL for 550 MHz operation
- Sets up voltage scaling for high performance
- Configures bus clock dividers

**uart_config.c:UART_Init()**
- Enables GPIOD and USART3 clocks
- Configures PD8 and PD9 as alternate function pins
- Initializes USART3 to 115200 baud, 8N1

**uart_config.c:UART_SendString()**
- Sends a null-terminated string via UART
- Uses HAL blocking transmit

### HAL Modules

The Lumos build tool automatically compiles HAL drivers based on the `hal_modules` specified in `project.yaml`:

```yaml
hal_modules:
  - uart
```

This example uses the `uart` module, which automatically includes:
- `stm32h7xx_hal_uart.c` - UART driver
- `stm32h7xx_hal_uart_ex.c` - Extended UART functions

The following core HAL drivers are **always** included automatically:
1. `stm32h7xx_hal.c` - Core HAL functions
2. `stm32h7xx_hal_cortex.c` - Cortex-M7 functions
3. `stm32h7xx_hal_rcc.c` - Clock control
4. `stm32h7xx_hal_rcc_ex.c` - Extended RCC
5. `stm32h7xx_hal_gpio.c` - GPIO control
6. `stm32h7xx_hal_pwr.c` - Power management
7. `stm32h7xx_hal_pwr_ex.c` - Extended power
8. `stm32h7xx_hal_dma.c` - DMA support

**Available HAL modules**: `uart`, `spi`, `i2c`, `adc`, `dac`, `tim`, `can`, `usb`, etc.

## Customization

### Change Baud Rate

Edit `include/uart_config.h`:

```c
#define UART_BAUDRATE    9600  // or 38400, 57600, 115200, etc.
```

### Change UART Instance

To use a different UART (e.g., USART1):

1. Edit `include/uart_config.h`:
   ```c
   #define UART_INSTANCE           USART1
   #define UART_TX_GPIO_PORT       GPIOA  // Check datasheet for pins
   #define UART_TX_PIN             GPIO_PIN_9
   #define UART_TX_AF              GPIO_AF7_USART1
   // ... update RX pin similarly
   ```

2. Rebuild with `lumos build`

### Change Clock Speed

Edit `src/uart_config.c:SystemClock_Config()`:

The PLL configuration is:
```
VCO = (HSE / PLLM) * PLLN
SYSCLK = VCO / PLLP
```

For example, for 480 MHz instead of 550 MHz:
```c
RCC_OscInitStruct.PLL.PLLN = 192;  // (25 / 5) * 192 = 960 MHz VCO
RCC_OscInitStruct.PLL.PLLP = 2;    // 960 / 2 = 480 MHz SYSCLK
```

## Troubleshooting

### No output on serial monitor

1. **Check connections**: Verify TX/RX are crossed (TX to RX, RX to TX)
2. **Check port**: Make sure you're using the correct COM port
3. **Check baud rate**: Must be exactly 115200
4. **Check power**: Ensure the board is powered and running
5. **Check reset**: Try pressing the reset button on the board

### Build fails

1. **Check Lumos root**: Make sure the build tool can find the LumosTool directory
2. **Check toolchain**: Ensure ARM GCC toolchain exists in `src/toolchains/`
3. **Check HAL modules**: Verify the HAL module names in `project.yaml` are correct

### Garbage characters on serial monitor

- **Wrong baud rate**: Make sure it's set to 115200
- **Clock issue**: The H7 might not be running at the expected frequency

### Board not responding after flash

- **Linker script issue**: The H723 linker script might not match your exact MCU variant
- **Clock configuration**: PLL settings might not be compatible with your crystal frequency
- **Try recovery**: Use STM32CubeProgrammer to erase and reflash

## Technical Details

### Memory Usage

- **Flash**: ~12-13 KB (out of 1 MB available)
- **RAM**: Minimal static allocation
  - Stack: Defined in linker script
  - Heap: Not used in this example

### Clock Configuration

- **HSE**: 25 MHz (external crystal)
- **PLL VCO**: 1100 MHz (25 MHz / 5 * 220)
- **SYSCLK**: 550 MHz (VCO / 2)
- **HCLK**: 275 MHz (SYSCLK / 2)
- **APB1/2/3/4**: 137.5 MHz (HCLK / 2)

### Linker Script

Uses `STM32H723VG_FLASH.ld` which defines:
- Flash: 1 MB starting at 0x08000000
- RAM: 564 KB (multiple regions)

## Next Steps

Now that you have UART working, you can:

1. **Add UART receive** - Implement a command parser
2. **Add interrupts** - Use UART RX interrupt instead of polling
3. **Add DMA** - Use DMA for efficient UART transfers
4. **Add other peripherals** - I2C, SPI, ADC, etc.
5. **Add FreeRTOS** - Create multiple tasks

## References

- [STM32H723 Datasheet](https://www.st.com/resource/en/datasheet/stm32h723vg.pdf)
- [STM32H723 Reference Manual](https://www.st.com/resource/en/reference_manual/rm0468-stm32h723733-stm32h725735-and-stm32h730-value-line-advanced-armbased-32bit-mcus-stmicroelectronics.pdf)
- [STM32H7 HAL User Manual](https://www.st.com/resource/en/user_manual/dm00392525-description-of-stm32h7-hal-and-lowlayer-drivers-stmicroelectronics.pdf)

## License

This example is provided as-is for demonstration purposes.
